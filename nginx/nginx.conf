worker_processes auto;

events {
    worker_connections 1024;
}

http {
    # Rate limit login: 5 requests / 1 minute
    limit_req_zone $binary_remote_addr zone=login_limit:10m rate=5r/m;

    # Rate limit API chung: 10 requests/s
    limit_req_zone $binary_remote_addr zone=api_limit:10m rate=10r/s;

    # Lưu userId được trả về từ user-service
    map $upstream_http_x_user_id $user_id {
        default $upstream_http_x_user_id;
    }

    # -------- Upstream HTTP services --------
    upstream user_service_http {
        server user-service:3000;
    }

    upstream post_service_http {
        least_conn;
        server post-service-1:3002;
        server post-service-2:3002;
    }

    upstream community_service_http {
        server community-service:3003;
    }

    upstream notification_service_http {
        server notification-service:3004;
    }

    # -------- gRPC upstream --------
    upstream community_service_grpc {
        server community-service:50051;
    }

    server {
        listen 80 http2;
        server_name api.hellodev.io.vn;

        # ---------- JWT VERIFY (internal only) ----------
        location = /_auth {
            internal;
            proxy_pass http://user_service_http/auth/validate;
            proxy_set_header Authorization $http_authorization;

            proxy_pass_request_body off;
            proxy_set_header Content-Length "";
        }

        # Block direct access to /auth/validate
        location = /auth/validate {
            return 403;
        }

        # ---------- LOGIN (rate limit riêng) ----------
        location /users/login {
            limit_req zone=login_limit burst=5 nodelay;
            proxy_pass http://user_service_http/users/login;
        }

        # ---------- PUBLIC AUTH API (register, login...) ----------
        location /auth/ {
            proxy_pass http://user_service_http;
        }

        # ---------- POST SERVICE ----------
        location /posts/ {
            auth_request /_auth;
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass http://post_service_http;

            proxy_set_header X-User-ID $user_id;
            proxy_set_header Authorization $http_authorization; # optional

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ---------- COMMUNITY SERVICE ----------
        location /communities/ {
            auth_request /_auth;
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass http://community_service_http;
            proxy_set_header X-User-ID $user_id;
            proxy_set_header Authorization $http_authorization;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ---------- NOTIFICATION SERVICE ----------
        location /notifications/ {
            auth_request /_auth;
            limit_req zone=api_limit burst=20 nodelay;

            proxy_pass http://notification_service_http;
            proxy_set_header X-User-ID $user_id;
            proxy_set_header Authorization $http_authorization;

            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }

        # ---------- gRPC SERVICE ----------
        location /grpc.CommunityService/ {
            auth_request /_auth;

            grpc_set_header Authorization $http_authorization;
            grpc_set_header X-User-ID $user_id;

            grpc_pass grpc://community_service_grpc;
        }
    }
}
